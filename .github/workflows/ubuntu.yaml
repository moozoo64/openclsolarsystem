name: ubuntu

on:
  workflow_dispatch:
  push:
    paths: ['.github/workflows/ubuntu.yaml','**/CMakeLists.txt', '**/Makefile', '**/*.h', '**/*.hpp', '**/*.c', '**/*.cpp', '**/*.cl', '**/*.cs', '**/*.sln', '**/*.csproj', '**/appsettings.json']
  pull_request:
    types: [opened, synchronize, reopened]
    paths: ['.github/workflows/ubuntu.yaml', '**/CMakeLists.txt', '**/Makefile', '**/*.h', '**/*.hpp', '**/*.c', '**/*.cpp', '**/*.cl', '**/*.cs', '**/*.sln', '**/*.csproj', '**/appsettings.json']

jobs:
  ubuntu:
    runs-on: ubuntu-24.04

    steps:
    - name: Install dependencies for wxWidgets
      run: |
        sudo apt-get update
        sudo apt-get install build-essential git cmake ninja-build libgl1 libgl1-mesa-dev mesa-utils libglu1-mesa-dev libedit-dev libgtk-3-dev libhunspell-dev pkg-config

    - name: Checkout WxWidgets
      uses: actions/checkout@v4
      with:
        repository: wxWidgets/wxWidgets
        ref: v3.2.7.1
        submodules: recursive
        path: wxWidgets

    - name: Cache wxWidgets
      uses: actions/cache@v3
      with:
        path: wxWidgets/build-release
        key: wxwidgets-${{ runner.os }}-${{ hashFiles('wxWidgets/**') }}
        restore-keys: |
          wxwidgets-${{ runner.os }}-

    - name: Build and install wxWidgets
      run: |
        mkdir -p wxWidgets/build-release
        cd wxWidgets/build-release
        ../configure --disable-debug_flag --with-gtk=3 --enable-stl --with-opengl
        make -j$(nproc) && sudo make install
        # Verify wx-config installation and setup
        sudo ldconfig
        which wx-config
        wx-config --version
        wx-config --libs
        wx-config --cxxflags

    - name: Install OpenCLSolarSystem dependencies
      run: sudo apt install build-essential git cmake ninja-build libgl1-mesa-dev libglew-dev opencl-headers ocl-icd-opencl-dev

    - name: Checkout OpenCLSolarSystem
      uses: actions/checkout@v4
      with:
        path: openclsolarsystem
        fetch-depth: 0

    - name: Build OpenCLSolarSystem
      run: |
        cd openclsolarsystem
        cmake -B build -S src/OpenCLSolarSystem --debug-find --log-level=VERBOSE -DCMAKE_BUILD_TYPE=Release -DwxWidgets_CONFIG_EXECUTABLE=/usr/local/bin/wx-config -DOpenGL_GL_PREFERENCE=GLVND
        cmake --build build --config Release -j$(nproc)

    - name: Setup dotnet 
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x.x'

    - name: Build OrbToSlf using dotnet
      run: |
        cd src/OrbToSlf
        # Build main projects to a specific output directory
        dotnet publish OrbToSlfConsole/OrbToSlfConsole.csproj --configuration Release --framework net8.0 --output ./OrbToSlfConsole/bin/Release/publish
        # Build and run tests with coverage
        dotnet test --configuration Release --collect:"XPlat Code Coverage" --results-directory:"./OrbToSlfConsole/bin/Release/TestResults" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura,opencover


